<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" >
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/vendor/bootstrap.min.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/vendor/bootstrap-select.min.css}" />	
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/style.css}" />		
    <title th:text="#{home.title}">TITLE</title>
</head>
<body class="bg-light"></body>

    <div th:include="navbar"></div>

    <div class="container mb-4">
        <div class="row justify-content-center">

            <!--Headline-->
            <div class="col-12 text-center mt-4">
                <h2 class="font-weight-bold">SURVEY RESULTS</h2>
                <h5 class="font-weight-light">YOU CAN CHECK OUT THE RESULTS OF A SURVEY HERE!</h5>
            </div>

            <div class="col-12" id="results"></div>

        </div>
    </div>

    <div th:include="footer"></div>

    <!--Resources-->
    <div id="resource-container" style="display: none;">
        <!--Question Template-->
        <div class="container result-container with-bars mt-3">
            <div class="row justify-content-between">
                <div class="col-auto">
                    <h5 class="question-type mt-2 mb-2"></h5>
                </div>
                <div class="col-1">
                    <a class="collapse-btn" data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseExample"><i class="fas fa-plus right collapse-icon"></i></a>
                </div>
            </div>
            <h5 class="question-type mt-2 mb-2"></h5>
            <div class="col answere-column p-0 mt-4 mb-2"></h5>
        </div>
        <!--Answere Template-->
        <div class="answere-template">
            <p class="result-text mb-0 mt-2"></p>
            <div class="d-flex flex-row">
                <div class="result-bar"></div>
                <div class="result-percent ml-2"></div>
            </div>
        </div>
    </div>
    
    <div th:replace="footer"></div>

</body>

<script th:inline="javascript">
    $(document).ready(function() {
        create_visuals();
        const bar_containers = document.getElementsByClassName("with-bars");
        bar_color(bar_containers);
    });
    const resources = document.getElementById("resource-container");
    var free_text_count = 0;

    function bar_color(question_list) {
        for (let i = 0; i < question_list.length; ++i) {
            const bars = question_list[i].getElementsByClassName("result-bar");
            for (let j = 0; j < bars.length; ++j) {
                bars[j].classList.add("bar-"+(j*Math.round(10/bars.length)));
            }
        }
    }
    function bar_fix(bar_element, bar_value) {
        bar_element.style.width = Math.round(bar_value*90)+"%";
    }

    function create_visuals() {
        const response_list = /*[[${response}]]*/ "responses";
        for (let i = 0; i < response_list.userResponses.length; ++i) {
            var answers = [];
            var answer = response_list.userResponses[i];
            var type = answer["type"];
            if (type == "TEXT_RESPONSE") {
                for (let j = 0; j < answer.responses.length; ++j) {
                    answers.push(create_answere(type, answer.responses[j], 0));
                }
            }
            else if (type == "MULTIPLE_CHOICE") {
                for (let j = 0; j < answer["multipleChoiceOptions"].length; ++j) {
                    answers.push(create_answere(type, answer["multipleChoiceOptions"][j], answer["multipleChoiceAnswers"][j]*0.01));
                }
            }
            else if (type == "SINGLE_CHOICE") {
                for (let j = 0; j < answer["singleChoiceOptions"].length; ++j) {
                    answers.push(create_answere(type, answer["singleChoiceOptions"][j], answer["singleChoiceAnswers"][j]*0.01));
                }
            }
            else if (type == "BINARY_ANSWER") {
                var total_answers = answer["yesTotal"]+answer["noTotal"];
                answers.push(create_answere(type, "Yes", answer["yesTotal"]/total_answers));
                answers.push(create_answere(type, "No", answer["noTotal"]/total_answers));
            }
            var question_template = create_question(type, answer["question"], answers);
            document.getElementById("results").appendChild(question_template);
        }
    }
    function create_question(type, text, answers) {
        var question = resources.getElementsByClassName("result-container")[0].cloneNode(true);
        delete_element(question.getElementsByClassName("answere-template")[0]);
        for (let i = 0; i < answers.length; ++i) {
            question.getElementsByClassName("answere-column")[0].appendChild(answers[i]);
        }
        if (type == "TEXT_RESPONSE") {
            question.classList.remove("with-bars");
            question.getElementsByClassName("answere-column")[0].classList.add("collapse");
            question.getElementsByClassName("answere-column")[0].id = "free-text-collapse-"+free_text_count;
            question.getElementsByClassName("collapse-btn")[0].href = "#free-text-collapse-"+free_text_count;
            free_text_count += 1;
            delete_element(question.getElementsByClassName("question-type")[1]);
        }
        else {
            delete_element(question.getElementsByClassName("row justify-content-between")[0]);
        }
        question.getElementsByClassName("question-type")[0].innerHTML = text;
        return question;
    }
    function create_answere(type, text, value) {
        if (type == "TEXT_RESPONSE") {
            var answere = resources.getElementsByClassName("result-text")[0].cloneNode(true);
            answere.innerHTML = text; answere.classList.add("result-free-text"); answere.classList.remove("result-text");
        }
        else {
            var answere = resources.getElementsByClassName("answere-template")[0].cloneNode(true);
            answere.getElementsByClassName("result-text")[0].innerHTML = text;
            answere.getElementsByClassName("result-percent")[0].innerHTML = Math.round(value*10000)/100+"%";
            bar_fix(answere.getElementsByClassName("result-bar")[0], value);
        }
        return answere;
    }
    function delete_element(element) {
        element.parentNode.removeChild(element);
    }

</script>

</html>