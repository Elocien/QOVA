<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" >
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.1.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.8.1/html2pdf.bundle.js"></script>

    <title th:text="#{title.surveyResults}">TITLE</title>
</head>
<body></body>

    <div th:include="navbar"></div>

    <div class="main container">
        <div class="row justify-content-center">

            <!--Headline-->
            <div class="col-12 text-center">
                <h2 class="font-weight-bold">SURVEY RESULTS</h2>
                <h5 class="font-weight-light">YOU CAN CHECK OUT THE RESULTS OF A SURVEY HERE!</h5>
                <a class="btn btn-primary btn-tu mt-4 mb-4" onclick="download_pdf()">DOWNLOAD RESULTS AS PDF</a>
            </div>

            <div class="col-12" id="results"></div>

        </div>
    </div>

    <div th:include="footer"></div>

    <!--Resources-->
    <div id="resource-container" style="display: none;">
        <!--Question Template-->
        <div class="container result-container with-bars mt-3">
            <div class="row align-items-center justify-content-between mt-2 mb-2">
                <div class="col-auto">
                    <h5 class="question-type m-0"></h5>
                </div>
                <div class="default-question col-2 text-right">
                    <p class="m-0"></p>
                </div>
                <div class="col-1 text-only">
                    <a class="collapse-btn" data-toggle="collapse" href="#" role="button" aria-expanded="false" aria-controls="collapseExample"><i class="fas fa-plus right collapse-icon"></i></a>
                </div>
            </div>
            <div class="col answere-column p-0 mt-4 mb-2"></h5>
        </div>
        <!--Answere Template-->
        <div class="answere-template">
            <p class="result-text mb-0 mt-2"></p>
            <div class="d-flex flex-row">
                <div class="result-bar"></div>
                <div class="result-percent ml-2"></div>
            </div>
        </div>
    </div>

</body>

<script th:inline="javascript">
    $(document).ready(function() {
        create_visuals();
        const bar_containers = document.getElementsByClassName("with-bars");
        bar_color(bar_containers);
    });
    const resources = document.getElementById("resource-container");
    var free_text_count = 0;

    function bar_color(question_list) {
        for (let i = 0; i < question_list.length; ++i) {
            const bars = question_list[i].getElementsByClassName("result-bar");
            for (let j = 0; j < bars.length; ++j) {
                bars[j].classList.add("bar-"+(j*Math.round(10/bars.length)));
            }
        }
    }
    function bar_fix(bar_element, bar_value) {
        bar_element.style.width = Math.round(bar_value*90)+"%";
    }

    function create_visuals() {
        var response_list = /*[[${resultsJson}]]*/ "responses";
        response_list = JSON.parse(response_list);
        for (let i = 0; i < response_list.length; ++i) {
            var answers = [];
            var answer = response_list[i];
            var type = answer["type"];
            if (type == "text") {
                for (let j = 0; j < answer["answers"].length; ++j) {
                    answers.push(create_answere(type, answer["answers"][j], 0));
                }
            }
            else {
                for (let j = 0; j < answer["options"].length; ++j) {
                    answers.push(create_answere(type, answer["options"][j], answer["answers"][j]));
                }
            }

            var question_template = create_question(type, answer["question"], answers);
            if (type != "text") {
                delete_multiple_elements(question_template.getElementsByClassName("text-only"));
            }
            if (answer["default"]) {
                var txt = /*[[#{default}]]*/"default";
                question_template.getElementsByClassName("default-question")[0].innerHTML = "("+txt+")";
            }
            else {
                delete_element(question_template.getElementsByClassName("default-question")[0]);
            }

            document.getElementById("results").appendChild(question_template);
        }
    }
    function create_question(type, text, answers) {
        var question = resources.getElementsByClassName("result-container")[0].cloneNode(true);
        delete_element(question.getElementsByClassName("answere-template")[0]);
        for (let i = 0; i < answers.length; ++i) {
            question.getElementsByClassName("answere-column")[0].appendChild(answers[i]);
        }
        if (type == "text") {
            question.getElementsByClassName("answere-column")[0].classList.add("collapse");
            question.getElementsByClassName("answere-column")[0].id = "free-text-collapse-"+free_text_count;
            question.getElementsByClassName("collapse-btn")[0].href = "#free-text-collapse-"+free_text_count;
            free_text_count += 1;
        }
        question.getElementsByClassName("question-type")[0].innerHTML = text;
        return question;
    }
    function create_answere(type, text, value) {
        if (type == "text") {
            var answere = resources.getElementsByClassName("result-text")[0].cloneNode(true);
            answere.innerHTML = text; answere.classList.add("result-free-text"); answere.classList.remove("result-text");
        }
        else {
            var answere = resources.getElementsByClassName("answere-template")[0].cloneNode(true);
            answere.getElementsByClassName("result-text")[0].innerHTML = text;
            answere.getElementsByClassName("result-percent")[0].innerHTML = Math.round(value*10000)/100+"%";
            bar_fix(answere.getElementsByClassName("result-bar")[0], value);
        }
        return answere;
    }
    function delete_element(element) {
        element.parentNode.removeChild(element);
    }
    function delete_multiple_elements(list_of_elements) {
        for (let i = 0; i < list_of_elements.length; i++) {
            delete_element(list_of_elements[i]);
        }
    }

    function download_pdf() {
        var results = document.getElementById("results").cloneNode(true);
        var opt = {
            margin:       0,
            filename:     'surveyResults.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 5 },
            jsPDF:        { unit: 'mm', format: 'letter', orientation: 'portrait' }
        };

        //Only used if type=text:
        var buttons = results.getElementsByTagName("a");
        console.log(buttons);
        delete_multiple_elements(buttons);
        var collapsed = results.getElementsByClassName("collapse");
        console.log(collapsed);
        for (let i = 0; i < collapsed.length; i++) {
            collapsed[i].classList.remove("collapse");
        }

        html2pdf(results, opt).save();
    }
</script>

</html>