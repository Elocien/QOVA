<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" >
<head>
    <link rel="stylesheet" type="text/css" th:href="@{/resources/css/questioneditor.css}" />
    <title th:text="#{title.editor}">TITLE</title>
</head>
<body>

    <div th:replace="navbar"></div>

    <div class="main col-lg-12">
        
        <h2 class="font-weight-bold text-center" th:text="#{editor.headline}">SURVEY EDITOR</h2>
        <h5 class="font-weight-light text-center"><span th:text="${coursename} + ': '"></span><span th:text="#{'editor.' + ${typeID}}"></span></h5>

        <div class="row">       
            <div class="col-lg-3 col-md-12 col-sm-12 text-center">
                <!--Menu-->
                <div class="sticky">
                    <div class="btn-group-vertical float-lg-right border border-dark rounded mt-4 sticky" role="group" aria-label="First group">
                        <button type="button" class="btn btn-head btn-text-right" th:text="#{question.new}">NEW QUESTION</button>
                        <button type="button" class="btn btn-list btn-text-right" onclick="addMultipleChoiceQuestion()"><span th:text="#{question.multiple-choice}"></span><i class="fas fa-plus-square ml-2"></i></button>
                        <button type="button" class="btn btn-list btn-text-right" onclick="addSingleChoiceQuestion()"><span th:text="#{question.single-choice}"></span><i class="fas fa-plus-square ml-2"></i></button>
                        <button type="button" class="btn btn-list btn-text-right" onclick="addYesNoQuestion()"><span th:text="#{question.yes-no-question}"></span><i class="fas fa-plus-square ml-2"></i></button>
                        <button type="button" class="btn btn-list btn-text-right" onclick="addOnetoFiveQuestion()"><span th:text="#{question.onetofive-question}"></span><i class="fas fa-plus-square ml-2"></i></button>
                        <button type="button" class="btn btn-list btn-text-right" onclick="addFreeTextQuestion()"><span th:text="#{question.free-text-question}"></span><i class="fas fa-plus-square ml-2"></i></button>
                        <button type="button" class="btn btn-head btn-text-right" th:text="#{question.edit}">OPTIONS</button>
                        <a type="button" class="btn btn-list btn-text-right" th:href="@{/course/details(id=${id})}" th:text="#{question.back}"></a>
                        <form th:action="@{/course/previewsurvey?type={type}&id={id}(type=${typeID}, id=${id})}" method="post" th:object="${form}" id="previewsurvey" style="width:100%">
                            <input type="text" name="questionnairejson" id="questionnairejson2" class="input"></input>
                            <button class="btn btn-list btn-text-right" type="submit" ><span th:text="#{question.preview}"></span><i class="fa fa-eye ml-2"></i></i></button>
                        </form>
                        <form th:action="@{/course/surveyeditor?type={type}&id={id}(type=${typeID}, id=${id})}" method="post" th:object="${form}" id="submitsurvey" style="width: 100%">
                            <input type="text" name="questionnairejson" id="questionnairejson" class="input"></input>
                            <button class="btn btn-list-last btn-text-right" type="submit"><span th:text="#{question.save}"></span><i class="fas fa-save custom-save ml-2"></i></button>
                        </form>
                    </div>
                </div>
            </div>
            <!--Questions-->
            <div class="col-lg-6 col-md-12 col-sm-12">
                <div id="questionnaire"></div>
                
                <!--Question Template-->
                <div id="question_template" class="container bg-white border border-secondary rounded mt-4">
                    <div class="row head-row">
                        <div class="col-md-8 pl-0">
                            <h3 class="text-light text-center index-number">0</h3>
                            <!--Change Question-->
                            <button class="btn btn-link dropdown-toggle question-headline font-weight-light" type="button" id="dropdownMenuButton(X)" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">QUESTION TYPE</button>
                            <div id="dropdown-menu" class="dropdown-menu" x-placement="bottom-start">
                                <a class="dropdown-item YesNo" onclick="changeQuestionTyp(1,1)" th:text="#{question.yes-no-question}">YesNo-Question</a>
                                <a class="dropdown-item MultipleChoice" onclick="changeQuestionTyp(1,2)" th:text="#{question.multiple-choice}">Multiple Question</a>
                                <a class="dropdown-item SingleChoice" onclick="changeQuestionTyp(1,3)" th:text="#{question.single-choice}">Single Choice</a>
                                <a class="dropdown-item OnetoFive" onclick="changeQuestionTyp(1,4)" th:text="#{question.onetofive-question}">OnetoFive-Question</a>
                                <a class="dropdown-item FreeText" onclick="changeQuestionTyp(1,5)" th:text="#{question.free-text-question}">Free-Text-Question</a>
                            </div>
                        </div>
                        <div class="col-md-4 pr-0">
                            <button class="btn btn-link nounderline pull-right m-1" onclick="question_delete(this)" data-toggle="tooltip" data-placement="top" data-original-title="Delete Question"><i class="fa fa-trash"></i></button>
                            <button class="btn btn-link nounderline pull-right m-1" onclick="question_clone(this)" data-toggle="tooltip" data-placement="top" data-original-title="Copy Question"><i class="fa fa-clone"></i></button>
                            <button class="btn btn-link nounderline pull-right m-1" onclick="question_move(this, 'up')" data-toggle="tooltip" data-placement="top" data-original-title="Move up one position"><i class="fa fa-arrow-up"></i></button>
                            <button class="btn btn-link nounderline pull-right m-1" onclick="question_move(this, 'down')" data-toggle="tooltip" data-placement="top" data-original-title="Move down one position"><i class="fa fa-arrow-down"></i></button>
                        </div>
                    </div>
                    <textarea class="row question-row Textarea Question ml-1 mr-1" maxlength="1024" placeholder="Question" style="height: 1px; overflow-y: hidden;"></textarea>
                    <div class="row options-row ml-4">
                        <div class="col-12 answer-col"></div>
                        <button class="btn btn-primary mb-2 editor-color new-answer-button" onclick="new_answer_button(this)">NEW ANSWER</button>
                    </div>
                </div>

                <!--Answer Template-->
                <div class="row" id="answer_template">
                    <div class="col-auto"><i class="far fa-circle"></i></div>
                    <div class="col-7"><textarea class="Textarea Question ml-1 mr-1" maxlength="1024" placeholder="Answer" style="height: 1px; overflow-y: hidden;"></textarea></div>
                    <div class="col-4">
                        <button class="btn btn-link nounderline" onclick="answer_delete(this)"><i class="fa fa-trash"></i></button>
                        <button class="btn btn-link nounderline" onclick="answer_clone(this)"><i class="fa fa-clone"></i></button>
                        <button class="btn btn-link nounderline" onclick="answer_move(this, 'up')"><i class="fa fa-arrow-up"></i></button>
                        <button class="btn btn-link nounderline" onclick="answer_move(this, 'down')"><i class="fa fa-arrow-down"></i></button>
                    </div>
                </div>

            </div>
            <div class="col-lg-3 col-md-0 col-sm-0"></div>
        </div>

    </div>
    
    <div th:replace="footer"></div>

    <script th:inline="javascript">

        //loading survey into javascript + rendering
        const survey = JSON.parse([[${survey}]]);
        function render_list(render_us) {
            for ( let i=0; i < render_us.length; i++){
                render_question_element(render_us[i], i)
            }
        }
        function render_all() {
            render_list(survey)
        }
        window.onload = function(){
            render_all()
        }

        function render_all_refresh() {
            document.getElementById("questionnaire").innerHTML = ""
            render_all()
        }

        //auto resize for the textareas
        const line_height = convertRemToPixels(2);
        var tx = document.getElementsByTagName('textarea');

        function refreshTextareas () {
            tx = document.getElementsByTagName('textarea');
            for (let i = 0; i < tx.length; i++) {
                tx[i].setAttribute('style', 'height:' + (tx[i].scrollHeight) + 'px;overflow-y:hidden;');
                tx[i].addEventListener("input", OnInput, false);
            }
            function OnInput() {
                if (line_height < this.scrollHeight) {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                }
            }
        }
        function convertRemToPixels(rem) {
            return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
        }
                
        function delete_element(element) {
            try {
                element.parentNode.removeChild(element);
            }
            catch(e) {
                console.log(e);
            }
        }

        //Bootsrapped
        function render_question_element (value, index){
            
            const template = document.getElementById("question_template").cloneNode(true);
            template.id = index;

            template.getElementsByClassName("index-number")[0].innerHTML = index+1;

            //dropdown fix (changes title & removes present )
            var target = template.getElementsByClassName("dropdown-menu")[0].getElementsByClassName(value["type"])[0]
            template.getElementsByClassName("dropdown-toggle")[0].innerHTML = target.innerHTML
            delete_element(target)

            //filling in the question if it exists
            var question_input = template.getElementsByClassName("question-row");
            question_input.id = index;
            if (value["question"] != "") {
                question_input.defaultValue = value["question"];
            }

            //adding/removing the choices
            var target = template.getElementsByClassName("options-row")[0];
            if (["SingleChoice", "MultipleChoice"].includes(value["type"])) {
                for ( let i=0; i < value["answers"].length; i++){
                    new_answer(target.getElementsByClassName("answer-col")[0], value["answers"][i])
                }
            }
            else {
                delete_element(target)
            }

            document.getElementById("questionnaire").appendChild(template);
        }

        //question buttons
        function question_delete(clicked_button) {
            var question_index = clicked_button.parentElement.parentElement.parentElement.id
            survey.splice(question_index, 1)
            render_all_refresh()
        }
        function question_clone(clicked_button) {
            var question_index = clicked_button.parentElement.parentElement.parentElement.id
            survey.splice(question_index, 0, survey[question_index])
            render_all_refresh()
        }
        function question_move(clicked_button, mode) {
            var question_index = clicked_button.parentElement.parentElement.parentElement.id
            var copied_element = survey[question_index]
            if ((mode === 'up') && (question_index > 0)) {
                survey.splice(question_index, 1)
                survey.splice(question_index-1, 0, copied_element)
            }
            else if ((mode === 'down') && (question_index < survey.length-1)) {
                survey.splice(question_index, 1)
                survey.splice(question_index+1, 0, copied_element)
            }
            render_all_refresh()
        }


        //adds new answer option
        function new_answer(target, content) {
            const template = document.getElementById("answer_template").cloneNode(true);
            template.removeAttribute('id');
            if (content != "") {
                template.getElementsByClassName("Textarea")[0].value = content;
            }
            target.appendChild(template);
        }
        function new_answer_button(clicked_button) {
            new_answer(clicked_button.parentElement.getElementsByClassName("answer-col")[0], "");
        }
        //answer buttons
        function answer_delete(clicked_button) {
            delete_element(clicked_button.parentElement.parentElement);
        }
        function answer_clone(clicked_button) {
            var content = clicked_button.parentElement.parentElement.getElementsByClassName("Textarea")[0].value;
            new_answer(clicked_button.parentElement.parentElement.parentElement, content)
        }
        function answer_move(clicked_button, mode) {
            var relevant_answer = clicked_button.parentElement.parentElement;
            var answer_container = relevant_answer.parentElement;
            //finding the position of the answer
            var answer_index = 0;
            for (let i=0; i < answer_container.children.length; i++) {
                if (answer_container.children[i] === relevant_answer) {
                    answer_index = i
                }
            }
            var relevant_answer_clone = relevant_answer.cloneNode(true)
            if ((mode === 'up') && (answer_index > 0)) {
                answer_container.insertBefore(relevant_answer_clone, answer_container.children[answer_index-1])
                delete_element(relevant_answer)
            }
            else if ((mode === 'down') && (answer_index < answer_container.children.length-1)) {
                answer_container.insertBefore(relevant_answer_clone, answer_container.children[answer_index+2])
                delete_element(relevant_answer)
            }
        }



        function saveInputs() {
            const textareas_question = document.getElementsByClassName("Textarea Question");
            for (let i=0;i<textareas_question.length;i++){
                const questionid = textareas_question[i].id;
                questionnaire[questionid].question = textareas_question[i].value;

            }

            const textareas_answer = document.getElementsByClassName("Textarea Answers");
            for (let i=0;i<textareas_answer.length;i++){
                const questionid = textareas_answer[i].parentElement.parentElement.parentElement.id;
                const answerid = textareas_answer[i].id;
                questionnaire[questionid].answers[answerid] = textareas_answer[i].value;

            }

        }

        function deleteQuestion(index) {
            saveInputs();
            questionnaire.splice(index,1);
            renderall();
        }

        function pushQuestionUp(index){
            saveInputs();
            const predecessor = index -1;
            const question = questionnaire[index];
            questionnaire[index]= questionnaire[predecessor];
            questionnaire[predecessor]=question;
            renderall();
        }

        function pushQuestionDown(index) {
            saveInputs();
            const predecessor = index +1;
            const question = questionnaire[index];
            questionnaire[index]= questionnaire[predecessor];
            questionnaire[predecessor]=question;
            renderall();

        }

        function addnewAnswer(index){
            saveInputs();
            if(questionnaire[index].answers.length<10) {
                questionnaire[index].answers.push("Answer");
            }
            else{
                alert("The maximum for possible answers is 10.");
            }
            renderall();
        }
        //jump
        
        function createButtonUpAnswer(index,answerindex){

            const btn_upAnswer = document.createElement("Button");
            btn_upAnswer.className = "btn btn-link btn-answere nounderline";
            btn_upAnswer.setAttribute("onclick", "pushAnswerup("+index+","+answerindex+")");

            const btn_icon = document.createElement("i");
            btn_icon.className = "fa fa-arrow-up";

            btn_upAnswer.setAttribute("data-toggle","tooltip");
            btn_upAnswer.setAttribute("data-placement","top");
            btn_upAnswer.title = [[#{question.up}]];

            btn_upAnswer.appendChild(btn_icon);

            return btn_upAnswer;
        }

        function pushAnswerup(q_index, a_index) {
            saveInputs();
            swapAnswer(q_index,(a_index-1),a_index);
            renderall();

        }


        function createButtonDownAnswer(index,answerindex){

            const btn_downAnswer = document.createElement("Button");
            btn_downAnswer.className = "btn btn-link btn-answere nounderline";
            btn_downAnswer.setAttribute("onclick", "pushAnswerdown("+index+","+answerindex+")");

            const btn_icon = document.createElement("i");
            btn_icon.className = "fa fa-arrow-down";

            btn_downAnswer.setAttribute("data-toggle","tooltip");
            btn_downAnswer.setAttribute("data-placement","top");
            btn_downAnswer.title = [[#{question.down}]];

            btn_downAnswer.appendChild(btn_icon);

            return btn_downAnswer;
        }

        function pushAnswerdown(q_index, a_index) {
            saveInputs();
            swapAnswer(q_index, a_index, (a_index+1));
            renderall();

        }

        function swapAnswer (q_index, a1_index, a2_index){
            const predecessor = questionnaire[q_index].answers[a1_index];
            questionnaire[q_index].answers[a1_index]= questionnaire[q_index].answers[a2_index];
            questionnaire[q_index].answers[a2_index] =predecessor;
        }

        function deleteanswer(indexq,indexa) {
            saveInputs();
            questionnaire[indexq].answers.splice(indexa,1);
            renderall();

        }

        function copyQuestion(index) {
            saveInputs();
            questionnaire.push(questionnaire[index]);
            renderall();

        }

        function loadsurveystring (){
            const survey = [(${survey})];
            for ( let i=0; i < survey.length; i++){
                questionnaire.push(survey[i]);

            }
            renderall();

        }


        //Onclick Show the Dropdown Content
        function hideshowdropdowntitle(q_index) {

            document.getElementById(q_index).getElementsByClassName("dropdown-content")[0].classList.toggle("show");
        }

        //Close Dropdwon if the User Clicks Outside
        //Problem das man mehrer Dropdown klicken kann ohne das vorherige schließt
        window.onclick = function (event) {
            if (!event.target.matches('.Buttondropdown')) {
                const dropdowns = document.getElementsByClassName("dropdown-content");
                for ( let i = 0; i<dropdowns.length; i++){
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains("show")){
                        openDropdown.classList.remove("show");
                    }
                }
            }

        }

        $(document).ready(function () {
            $("form").submit(function () {
                saveInputs();
            })
        });

        $('#submitsurvey').submit(function () {
            saveInputs();
            document.getElementById("questionnairejson").value = JSON.stringify(questionnaire);
            return true;
        });
        $('#previewsurvey').submit(function () {
            saveInputs();
            document.getElementById("questionnairejson2").value = JSON.stringify(questionnaire);
            return true;
        });

    </script>

</body>
</html>